document.addEventListener("DOMContentLoaded",(()=>{document.body.classList.remove("search-done");const t=document.getElementById("search-form"),e=document.getElementById("postcode"),n=document.getElementById("address-container");function o(t){return t?t.parent&&t.parent.name?t.parent.name:t.name||null:null}function r(t){return(t||"").toString().toLowerCase().replace(/\s+/g," ").trim()}function s(){document.querySelectorAll(".area").forEach((t=>t.classList.remove("visible")))}function a(t){if(s(),!t)return;const e=r(t);if(!e)return;const n=Array.from(document.querySelectorAll(".area")).filter((t=>{const n=t.querySelector(".area-name"),o=n?r(n.textContent):"";return o===e||o.includes(e)||e.includes(o)}));if(0!==n.length){n.forEach((t=>t.classList.add("visible")));try{n[0].scrollIntoView({behavior:"smooth",block:"center"}),n[0].focus?.()}catch(t){}}}async function i(t){const e=await fetch(t);if(!e.ok){const t=await e.text();return{ok:!1,status:e.status,statusText:e.statusText,bodyText:t}}const n=(e.headers.get("content-type")||"").toLowerCase();if(n.includes("application/json")||n.includes("+json")){return{ok:!0,json:await e.json()}}const o=await e.text();if(o.trim().startsWith("<"))return{ok:!1,html:!0,bodyText:o};try{return{ok:!0,json:JSON.parse(o)}}catch{return{ok:!1,bodyText:o}}}t.addEventListener("submit",(async t=>{t.preventDefault(),n.textContent="",s();const r=e.value.trim();if(!r)return void(n.textContent="Please enter a postcode.");document.body.classList.add("search-done"),n.textContent="Searching...";const c="https://www.gov.uk/api/local-authority?postcode="+encodeURIComponent(r),d="https://api.allorigins.win/raw?url="+encodeURIComponent(c);try{const t=await i(d);if(!t.ok)return t.html||t.bodyText&&t.bodyText.trim().startsWith("<")?void(n.textContent="Postcode Invalid"):void(n.innerHTML=`<div>Error: ${String(t.status||"")} ${String(t.statusText||"")}</div><pre>${String(t.bodyText||"")}</pre>`);const e=t.json;if(e&&Array.isArray(e.addresses)){const t=e.addresses;if(0===t.length)return void(n.textContent="No addresses found for that postcode.");n.textContent="";const r=document.createElement("select");r.id="addresses-select";const c=document.createElement("option");return c.value="",c.textContent="-- choose an address --",r.appendChild(c),t.forEach(((t,e)=>{const n=document.createElement("option");n.value=t.local_authority_slug||"",n.textContent=t.address||`Address ${e+1}`,r.appendChild(n)})),r.addEventListener("change",(async t=>{const e=t.target.value;if(s(),!e)return;n.textContent="Loading authority data...";const r="https://www.gov.uk/api/local-authority/"+encodeURIComponent(e),c="https://api.allorigins.win/raw?url="+encodeURIComponent(r);try{const t=await i(c);if(!t.ok)return t.html||t.bodyText&&t.bodyText.trim().startsWith("<")?void(n.textContent="Authority response invalid"):void(n.innerHTML=`<div>Error fetching authority: ${String(t.status||"")} ${String(t.statusText||"")}</div><pre>${String(t.bodyText||"")}</pre>`);const e=t.json;if(e&&e.local_authority){const t=o(e.local_authority);n.innerHTML=`<div><strong>${String(t||"none")}</strong></div>`,a(t)}else n.innerHTML=`<pre>${JSON.stringify(e,null,2)}</pre>`}catch(t){n.textContent="Network error: "+t.message}})),void n.appendChild(r)}if(e&&e.local_authority){const t=o(e.local_authority);return n.innerHTML=`<div><strong>${String(t||"none")}</strong></div>`,void a(t)}n.innerHTML=`<pre>${JSON.stringify(e,null,2)}</pre>`}catch(t){n.textContent="Network error: "+t.message}}))}));