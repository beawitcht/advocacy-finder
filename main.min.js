document.addEventListener("DOMContentLoaded",(()=>{document.body.classList.remove("search-done");const t=document.getElementById("search-form"),e=document.getElementById("postcode"),n=document.getElementById("address-container"),o=document.getElementById("area-dropdown"),r=document.getElementById("area-search");let a=[];function s(t){return t?t.parent&&t.parent.name?t.parent.name:t.name||null:null}function c(t){return(t||"").toString().toLowerCase().replace(/\s+/g," ").trim()}function d(){document.querySelectorAll(".area").forEach((t=>t.classList.remove("visible")))}function i(t){if(d(),!t)return;const e=c(t);if(!e)return;const n=Array.from(document.querySelectorAll(".area")).filter((t=>{const n=t.querySelector(".area-name");return(n?c(n.textContent):"")===e}));if(0!==n.length){n.forEach((t=>t.classList.add("visible")));try{n[0].scrollIntoView({behavior:"smooth",block:"center"}),n[0].focus?.()}catch(t){}}}async function l(t){const e=await fetch(t);if(!e.ok){const t=await e.text();return{ok:!1,status:e.status,statusText:e.statusText,bodyText:t}}const n=(e.headers.get("content-type")||"").toLowerCase();if(n.includes("application/json")||n.includes("+json")){return{ok:!0,json:await e.json()}}const o=await e.text();if(o.trim().startsWith("<"))return{ok:!1,html:!0,bodyText:o};try{return{ok:!0,json:JSON.parse(o)}}catch{return{ok:!1,bodyText:o}}}o&&(a=Array.from(o.options).slice(1)),o&&o.addEventListener("change",(t=>{const e=t.target.value;e?(document.body.classList.add("search-done"),n.textContent="",i(e)):(d(),document.body.classList.remove("search-done"))})),r&&(r.addEventListener("input",(t=>{const e=c(t.target.value);for(;o.options.length>1;)o.remove(1);const n=a.filter((t=>c(t.textContent).includes(e)));n.forEach((t=>{o.add(t.cloneNode(!0))})),1===n.length&&e&&(o.selectedIndex=1,o.dispatchEvent(new Event("change")))})),r.addEventListener("focus",(()=>{r.select()}))),t.addEventListener("submit",(async t=>{t.preventDefault(),n.textContent="",d();const o=e.value.trim();if(!o)return void(n.textContent="Please enter a postcode.");document.body.classList.add("search-done"),n.textContent="Searching...";const r="https://www.transinformed.co.uk/api/pass-thru?query=https://www.gov.uk/api/local-authority?postcode="+encodeURIComponent(o);try{const t=await l(r);if(!t.ok)return t.html||t.bodyText&&t.bodyText.trim().startsWith("<")?void(n.textContent="Postcode Invalid"):void(n.innerHTML=`<pre>Error: ${t.status} ${t.statusText}\n\n${String(t.bodyText||"")}</pre>`);const e=t.json;if(e&&Array.isArray(e.addresses)){const t=e.addresses;if(0===t.length)return void(n.textContent="No addresses found for that postcode.");n.textContent="";const o=document.createElement("select");o.id="addresses-select";const r=document.createElement("option");return r.value="",r.textContent="-- choose an address --",o.appendChild(r),t.forEach(((t,e)=>{const n=document.createElement("option");n.value=t.local_authority_slug||"",n.textContent=t.address||`Address ${e+1}`,o.appendChild(n)})),o.addEventListener("change",(async t=>{const e=t.target.value;if(d(),!e)return;n.textContent="Loading authority data...";const o="https://www.transinformed.co.uk/api/pass-thru?query=https://www.gov.uk/api/local-authority/"+encodeURIComponent(e);try{const t=await l(o);if(!t.ok)return t.html||t.bodyText&&t.bodyText.trim().startsWith("<")?void(n.textContent="Authority response invalid"):void(n.innerHTML=`<pre>Error: ${t.status} ${t.statusText}\n\n${String(t.bodyText||"")}</pre>`);const e=t.json;if(e&&e.local_authority){const t=s(e.local_authority);n.innerHTML=`${t||"Unknown"}`,i(t)}}catch(t){n.textContent="Network error: "+t.message}})),void n.appendChild(o)}if(e&&e.local_authority){const t=s(e.local_authority);n.innerHTML=`${t||"Unknown"}`,i(t)}}catch(t){n.textContent="Network error: "+t.message}})),document.addEventListener("click",(t=>{const e=t.target.closest&&t.target.closest(".copy-link");if(!e)return;t.preventDefault();const n=e.getAttribute("data-copy-value")||e.textContent||"";if(!n)return;const o=()=>{const t=e.getAttribute("aria-label");e.classList.add("copied"),e.setAttribute("aria-label","Copied"),setTimeout((()=>{e.classList.remove("copied"),e.setAttribute("aria-label",t||"Copy")}),120)};if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(n).then(o).catch((()=>{try{const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),o()}catch(t){}}));else try{const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),o()}catch(t){}}))}));